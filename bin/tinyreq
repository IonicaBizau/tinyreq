#!/usr/bin/env node

// Dependencies
var TinyReq = require("../lib")
  , Clp = require("clp")
  , Logger = require("bug-killer")
  , Ul = require("ul")
  , Package = require("../package")
  ;

// CLP Parser
var urlOpt = new Clp.Option(["u", "url"], "The request url.", "url")
  , methOpt = new Clp.Option(["m", "method"], "The request method.", "method")
  , dataOpt = new Clp.Option(["d", "data"], "The request data.", "data")
  , fieldsOpt = new Clp.Option(["f", "fields"], "Other fields to merge in the request object.", "fields")
  ;

new Clp({
    name: "TinyReq"
  , exe: Package.name
  , version: Package.version
  , docs_url: Package.homepage
  , process: true
  , examples: [
        "tinyreq -u http://ionicabizau.net"
    ]
}, [urlOpt, methOpt, dataOpt, fieldsOpt]);

// Merge the options
var options = Ul.merge({
    method: methOpt.value || undefined
  , url: urlOpt.value || undefined
  , data: dataOpt.value || undefined
}, {
    method: "GET"
});

if (!options.url) {
    return Logger.log("Missing the request url.", "error");
}

if (options.data && options.method === "GET") {
    Logger.log("Making a POST request since you send data.", "warn");
    options.method = "POST";
}

// Make the request
Logger.log(options.method + " " + options.url, "info");
TinyReq(options, function (err, body) {
    if (err) {
        return Logger.log(err, "error");
    }
    console.log(body);
});
